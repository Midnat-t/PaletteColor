# Система аналитики

## Обзор

Приложение включает полноценную систему сбора и анализа метрик для мониторинга качества и производительности.

## Компоненты системы

### 1. AppMonitor

Центральный класс для сбора всех метрик.

**Расположение:** `monitoring/AppMonitor.kt`

**Ответственность:**
- Отслеживание сессий
- Запись ошибок и крешей
- Сбор метрик производительности
- Учет использования функций
- Сбор отзывов пользователей

### 2. AnalyticsDatabase

Room база данных для хранения аналитических данных.

**Расположение:** `database/AnalyticsDatabase.kt`

**Таблицы:**
- sessions
- crashes
- errors
- performance_metrics
- feature_usage
- feedback

### 3. AnalyticsDao

Data Access Object для работы с базой данных.

**Расположение:** `database/dao/AnalyticsDao.kt`

## Собираемые метрики

### Сессии пользователя

**Сущность:** `SessionEntity`

**Поля:**
- `id` - уникальный идентификатор
- `startTime` - время начала сессии
- `endTime` - время окончания
- `duration` - длительность в миллисекундах
- `appVersion` - версия приложения
- `androidVersion` - версия Android
- `deviceModel` - модель устройства

**Сбор:**
- Начало: `onResume()` в MainActivity
- Конец: `onPause()` в MainActivity

**Метрики:**
- Общее количество сессий
- Средняя длительность сессии
- Retention rate (возвращаемость пользователей)

### Крэши

**Сущность:** `CrashEntity`

**Поля:**
- `id` - уникальный идентификатор
- `timestamp` - время краша
- `exceptionType` - тип исключения
- `exceptionMessage` - сообщение об ошибке
- `stackTrace` - stack trace
- `appVersion` - версия приложения
- `androidVersion` - версия Android
- `deviceModel` - модель устройства

**Сбор:**
- Через `AppMonitor.recordCrash(throwable)`

**Метрики:**
- Crash rate (процент сессий с крешами)
- Общее количество крешей
- Крэши за последние 7 дней

### Ошибки

**Сущность:** `ErrorEntity`

**Поля:**
- `id` - уникальный идентификатор
- `timestamp` - время ошибки
- `errorType` - тип ошибки
- `errorMessage` - сообщение
- `context` - контекст возникновения
- `severity` - уровень серьезности (LOW, MEDIUM, HIGH, CRITICAL)

**Сбор:**
- Автоматически при catch блоках в ViewModel
- Через `AppMonitor.recordError(...)`

**Метрики:**
- Error rate (процент сессий с ошибками)
- Ошибки по уровню серьезности
- Ошибки за последние 7 дней

### Метрики производительности

**Сущность:** `PerformanceMetricEntity`

**Поля:**
- `id` - уникальный идентификатор
- `timestamp` - время записи
- `metricType` - тип метрики
- `duration` - длительность в миллисекундах
- `success` - успешность операции
- `additionalData` - дополнительные данные

**Типы метрик:**
- `APP_START` - время запуска приложения
- `IMAGE_PROCESSING` - обработка изображения
- `SCREEN_LOAD` - загрузка экрана
- `COLOR_EXTRACTION` - извлечение цветов
- `DATABASE_QUERY` - запрос к БД

**Сбор:**
- Запуск приложения: `onCreate()` в MainActivity
- Обработка изображения: `ColorPaletteViewModel.processImage()`

**Метрики:**
- Среднее время запуска
- Среднее время обработки изображения
- Min/Max длительность операций
- Процент неудачных операций

### Использование функций

**Сущность:** `FeatureUsageEntity`

**Поля:**
- `id` - уникальный идентификатор
- `timestamp` - время использования
- `featureName` - название функции
- `sessionId` - связь с сессией

**Отслеживаемые функции:**
- color_extraction - извлечение цветов
- copy_color - копирование hex-кода
- share_palette - поделиться палитрой
- save_image - сохранение изображения

**Сбор:**
- Через `AppMonitor.trackFeatureUsage(featureName)`

**Метрики:**
- Количество использований каждой функции
- Популярные функции
- Дни активного использования функции

### Отзывы пользователей

**Сущность:** `FeedbackEntity`

**Поля:**
- `id` - уникальный идентификатор
- `timestamp` - время отзыва
- `rating` - оценка (1-5 звезд)
- `comment` - текстовый комментарий
- `appVersion` - версия приложения
- `contextInfo` - контекст отзыва

**Сбор:**
- Через диалог обратной связи в UI
- Автоматически через 5 секунд после успешного извлечения цветов

**Метрики:**
- CSI (Customer Satisfaction Index)
- NPS (Net Promoter Score)
- Средний рейтинг
- Положительные/отрицательные отзывы

## Расчет ключевых метрик

### CSI (Customer Satisfaction Index)

```kotlin
CSI = (Средний рейтинг / 5) × 100%
```

Пример: если средний рейтинг 4.5, то CSI = 90%

**Интерпретация:**
- 80-100% - Отлично
- 60-80% - Хорошо
- Ниже 60% - Требует улучшения

### NPS (Net Promoter Score)

```kotlin
Promoters = рейтинг 4-5 звезд (довольные пользователи)
Detractors = рейтинг 1-2 звезды (недовольные)
Passives = рейтинг 3 звезды (нейтральные, не учитываются)

NPS = ((Promoters - Detractors) / Total) × 100
```

Пример: 10 отзывов, 7 с рейтингом 4-5, 1 с рейтингом 1-2, 2 с рейтингом 3
NPS = ((7 - 1) / 10) × 100 = 60

**Интерпретация:**
- Выше 50 - Отлично
- 0-50 - Хорошо
- Ниже 0 - Плохо

### Crash Rate

```kotlin
Crash Rate = (Количество крешей / Количество сессий) × 100%
```

**Интерпретация:**
- Ниже 1% - Отлично
- 1-5% - Приемлемо
- Выше 5% - Требует немедленного исправления

### Error Rate

```kotlin
Error Rate = (Количество ошибок / Количество сессий) × 100%
```

**Интерпретация:**
- Ниже 1% - Отлично
- 1-5% - Приемлемо
- Выше 5% - Требует внимания

### Retention Rate

```kotlin
Retention Rate = (Уникальных дней использования / Период в днях) × 100%
```

Для 7-дневного периода: количество дней, когда пользователь открывал приложение

**Интерпретация:**
- Выше 80% - Отлично (пользователь открывает почти каждый день)
- 50-80% - Хорошо
- Ниже 50% - Низкая вовлеченность

## Health Report

Комплексный отчет о состоянии приложения.

**Структура:**
```kotlin
data class HealthReport(
    val crashRate: Double,              // Процент крешей
    val errorRate: Double,              // Процент ошибок
    val avgSessionLength: Double,       // Средняя длительность сессии (мс)
    val avgAppStartTime: Double,        // Среднее время запуска (мс)
    val retentionRate7Days: Double,     // Retention за 7 дней (%)
    val csi: Double,                    // Customer Satisfaction Index (%)
    val nps: Double,                    // Net Promoter Score
    val totalSessions: Int,             // Всего сессий
    val totalCrashes: Int,              // Всего крешей
    val totalErrors: Int,               // Всего ошибок
    val totalFeedback: Int              // Всего отзывов
)
```

**Получение:**
```kotlin
val report = appMonitor.getHealthReport()
```

## Очистка данных

### Автоматическая очистка старых данных

```kotlin
appMonitor.cleanupOldData(daysToKeep = 30)
```

Удаляет данные старше указанного количества дней.

### Полная очистка

```kotlin
appMonitor.clearAllData()
```

Удаляет все аналитические данные из базы.

## Analytics Dashboard

Визуальное представление метрик в приложении.

**Компоненты:**
- Заголовок с общей информацией
- Primary Metrics (Crash Rate, Error Rate)
- Performance Metrics (Avg Session, App Start Time)
- User Satisfaction (CSI, NPS, Retention)
- Statistics (общие счетчики)

**Цветовое кодирование:**
- Зеленый - хорошие показатели
- Оранжевый - требует внимания
- Красный - критические проблемы

## Интеграция с внешними сервисами

Текущая реализация использует локальное хранение. Для production рекомендуется интеграция с:

- Firebase Analytics
- Firebase Crashlytics
- Google Analytics
- Custom backend API

## Приватность

Все данные хранятся локально на устройстве пользователя и не отправляются на внешние серверы.

## Производительность

Система аналитики спроектирована с учетом производительности:
- Асинхронная запись (Coroutines)
- Фоновый поток (Dispatchers.IO)
- Батчинг операций
- Эффективные SQL запросы

